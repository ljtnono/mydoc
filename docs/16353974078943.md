# SpringCloudAlibaba学习总结

## 服务治理的概念

在单体服务架构中，服务治理的挑战更多是当单体架构由于承载的业务庞大，服务内部逻辑变得复杂，扩展性也变差。这时候往往不需要特别的服务治理手段，而是将单体服务拆分为微服务，即完成“微服务化”，将原有的单体服务架构向微服务架构演进。

在微服务架构中，出现了新的服务问题，从而需要对服务进行服务治理。这里新的服务问题如：服务注册与发现、服务流量管理、服务安全等统称为服务治理。

## Nacos 服务治理

Nacos 是alibaba推出的一种服务治理框架，由于与SpringCloud能够很好的集成，并且在功能性上比之Netflix公司开源的eureka有过之而无不及，逐渐在国内流行起来。下面是Nacos与Eureka功能对比表格。

| 对比项目\注册中心  | Spring Cloud Nacos                                           | SpringCloud Eureka                                           |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| CAP模型            | 支持AP和CP模型                                               | AP模型                                                       |
| 客户端更新服务信息 | 使用注册+DNS-f+健康检查模式。DNS-f客户端使用监听模式push/pull拉取更新信息 | 客户端定时轮询服务端获取其他服务ip信息并对比，相比之下服务端压力较大、延迟较大 |
| 伸缩性             | 使用Raft选举算法性能、可用性、容错性均比较好，新加入节点无需与所有节点互相广播同步信息 | 由于使用广播同步信息，集群超过1000台机器后对eureka集群压力很大 |
| 健康检查模式/方式  | 支持服务端/客户端/关闭检查模式，检查方式有tcp、http、sql。支持自己构建健康检查器 | 客户端向压力服务端发送http心跳                               |
| 负载均衡           | 支持                                                         | 支持                                                         |
| 手动上下线服务方式 | 通过控制台页面和API                                          | 通过调用API                                                  |
| 跨中心同步         | 支持                                                         | 不支持                                                       |
| k8s集成            | 支持                                                         | 不支持                                                       |
| 分组               | Nacos可用根据业务和环境进行分组管理                          | 不支持                                                       |
| 权重               | Nacos默认提供权重设置功能，调整承载流量压力                  | 不支持                                                       |
| 厂商               | 阿里巴巴                                                     | Netflix                                                      |

从上面对比可以了解到，Nacos作为服务发现中心，具备更多的功能支持项，且从长远来看Nacos在以后的版本会支持SpringCloud+K8s的组合，填补2者的鸿沟，在两套体系下可以采用同一套服务发现和配置管理的解决方案，这将大大的简化使用和维护的成本。另外，Nacos计划实现Service Mesh，也是未来微服务发展的趋势。

### Nacos 特性

Nacos主要提供以下四大功能：

1. 服务发现与服务健康检查

   Nacos使服务更容易注册，并通过DNS或HTTP接口发现其他服务，Nacos还提供服务的实时健康检查，以防止向不健康的主机或服务实例发送请求。

2. 动态配置管理

   动态配置服务允许您在所有环境中以集中和动态的方式管理所有服务的配置。Nacos消除了在更新配置时重新部署应用程序，这使配置的更改更加高效和灵活。

3. 动态DNS服务

   Nacos提供基于DNS协议的服务发现能力，旨在支持异构语言的服务发现，支持将注册在Nacos上的服务以域名的方式暴露端点，让三方应用方便的查阅及发现。

4. 服务和元数据管理

   Nacos能让您从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略。

### Nacos基本架构及概念

![Nacos架构图](https://ljtnono.oss-cn-beijing.aliyuncs.com/images/1561217892717-1418fb9b-7faa-4324-87b9-f1740329f564.jpeg)

#### 服务（Service）

服务是指一个或一组软件功能（例如特定信息的检索或一组操作的执行），其目的是不同的客户端可以为不同的目的的重用（例如通过跨进程的网络调用）。Nacos支持主流的服务生态，如Kubernetes Service、gRPC|Dubbo RPC Service或者Spring Cloud RESTful Service.

#### 服务注册中心（Service Registry)

服务注册中心，它是服务，其实例及元数据的数据库。服务实例在启动时注册到服务注册表，并在关闭时注销。服务和路由器的客户端查询服务注册表以查找服务的可用实例。服务注册中心可能会调用服务实例的健康检查API来验证它是否能够处理请求。

#### 服务元数据（Service Metadata）

服务元数据是指包括服务端点（endpoint）、服务标签、服务版本号、服务实例权重、路由规则、安全策略等描述服务的数据。

#### 服务提供方（Service Provider）

是指提供可复用和可调用服务的应用方。

#### 服务消费方（Service Consumer）

是指会发起对某个服务调用的应用方。

#### 配置（Configuration）

在系统开发过程中通常会将一些需要变更的参数、变量等从代码中分离出来独立管理，以独立的配置文件的形式存在。目的是让静态的系统工件或者交付物（如 WAR，JAR 包等）更好地和实际的物理运行环境进行适配。配置管理一般包含在系统部署的过程中，由系统管理员或者运维人员完成这个步骤。配置变更是调整系统运行时的行为的有效手段之一。

#### 配置管理 (Configuration Management)

在数据中心中，系统中所有配置的编辑、存储、分发、变更管理、历史版本管理、变更审计等所有与配置相关的活动统称为配置管理。

#### 名字服务 (Naming Service)

提供分布式系统中所有对象(Object)、实体(Entity)的“名字”到关联的元数据之间的映射管理服务，例如 ServiceName -> Endpoints Info, Distributed Lock Name -> Lock Owner/Status Info, DNS Domain Name -> IP List, 服务发现和 DNS 就是名字服务的2大场景。

#### 配置服务 (Configuration Service)

在服务或者应用运行过程中，提供动态配置或者元数据以及配置管理的服务提供者。



### 逻辑架构及其组件介绍

![Nacos逻辑架构及其组件介绍](https://ljtnono.oss-cn-beijing.aliyuncs.com/images/1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png)

- 服务管理：实现服务CRUD，域名CRUD，服务健康状态检查，服务权重管理等功能
- 配置管理：实现配置管CRUD，版本管理，灰度管理，监听管理，推送轨迹，聚合数据等功能
- 元数据管理：提供元数据CURD 和打标能力
- 插件机制：实现三个模块可分可合能力，实现扩展点SPI机制
- 事件机制：实现异步化事件通知，sdk数据变化异步通知等逻辑
- 日志模块：管理日志分类，日志级别，日志可移植性（尤其避免冲突），日志格式，异常码+帮助文档
- 回调机制：sdk通知数据，通过统一的模式回调用户处理。接口和数据结构需要具备可扩展性
- 寻址模式：解决ip，域名，nameserver、广播等多种寻址模式，需要可扩展
- 推送通道：解决server与存储、server间、server与sdk间推送性能问题
- 容量管理：管理每个租户，分组下的容量，防止存储被写爆，影响服务可用性
- 流量管理：按照租户，分组等多个维度对请求频率，长链接个数，报文大小，请求流控进行控制
- 缓存机制：容灾目录，本地缓存，server缓存机制。容灾目录使用需要工具
- 启动模式：按照单机模式，配置模式，服务模式，dns模式，或者all模式，启动不同的程序+UI
- 一致性协议：解决不同数据，不同一致性要求情况下，不同一致性机制
- 存储模块：解决数据持久化、非持久化存储，解决数据分片问题
- Nameserver：解决namespace到clusterid的路由问题，解决用户环境与nacos物理环境映射问题
- CMDB：解决元数据存储，与三方cmdb系统对接问题，解决应用，人，资源关系
- Metrics：暴露标准metrics数据，方便与三方监控系统打通
- Trace：暴露标准trace，方便与SLA系统打通，日志白平化，推送轨迹等能力，并且可以和计量计费系统打通
- 接入管理：相当于阿里云开通服务，分配身份、容量、权限过程
- 用户管理：解决用户管理，登录，sso等问题
- 权限管理：解决身份识别，访问控制，角色管理等问题
- 审计系统：扩展接口方便与不同公司审计系统打通
- 通知系统：核心数据变更，或者操作，方便通过SMS系统打通，通知到对应人数据变更
- OpenAPI：暴露标准Rest风格HTTP接口，简单易用，方便多语言集成
- Console：易用控制台，做服务管理、配置管理等操作
- SDK：多语言sdk
- Agent：dns-f类似模式，或者与mesh等方案集成
- CLI：命令行对产品进行轻量化管理，像git一样好用

### Nacos服务发现快速入门

在介绍使用Nacos作为服务发现程序之前，先要了解SpringCloud的服务协作流程，下图展现了SpringCloud的服务协作流程。

![SpringCloud服务协作流程](https://ljtnono.oss-cn-beijing.aliyuncs.com/images/image-20200515234018714.png)

（1）在微服务启动时，会向服务发现中心上报自身信息，这里ServiceB包含多个实例。

每个实例包括：IP地址、端口号信息。

（2）微服务会定期从Nacos Server（服务发现中心）获取服务实例列表。

（3）当ServiceA调用ServiceB时，ribbon组件从本地服务实例列表中查找ServiceB的实例，如获取了多个实例如Instance1、Instance2。这时ribbon会通过用户所配置的负载均衡策略中选择一个实例。

（4）最终，Feign组件会通过ribbon选取的实例发送Http请求。

采用Feign+Ribbon的整合方式，是由Feign完成远程调用的整个流程。而Feign集成了Ribbon，Feign使用Ribbon完成调用实例的负载均衡。

#### 负载均衡的概念

在SpringCloud服务协议流程中，ServiceA通过负载均衡调用ServiceB,下边来了解一下负载均衡：

**负载均衡**就是将用户请求（流量）通过一定的策略，分摊在多个服务实例上执行，它是系统处理高并发、缓解网络压力和进行服务端扩容的重要手段之一。它分为**服务端均衡负载**和**客户端均衡负载**。

**服务端负载均衡**：

![服务端负载均衡](https://ljtnono.oss-cn-beijing.aliyuncs.com/images/image-20200516222144386.png)

在负载均衡器中维护一个可用的服务实例清单，当客户端请求来临时，负载均衡服务器按照某种配置好的规则（负载均衡算法）从可用服务实例清单中选区其一去处理客户端的请求。这就是服务端负载均衡。

**客户端负载均衡**

![客户端负载均衡](https://ljtnono.oss-cn-beijing.aliyuncs.com/images/image-20200516230241328.png)

与服务端负载均衡不一样的是，服务实例清单是保存在客户端中的。接下来要讲的Ribbon就属于客户端负载均衡。在ribbon客户端会有一个服务实例地址列表，在发送请求前通过负载均衡算法选择一个服务实例，然后进行访问，这是客户端负载均衡。即在客户端就进行负载均衡算法分配。

